#!/usr/bin/env python
import rospy
from challenge_dishwasher.open_dishwasher import OpenDishwasher
from robot_skills.util.entity import Entity
from robot_smach_states import StartChallengeRobust, NavigateToWaypoint, Say, Find, Grab, NavigateToSymbolic, \
    HearOptions
from robot_smach_states.util import startup
from robot_smach_states.util.designators import EdEntityDesignator, VariableDesignator, EntityByIdDesignator, \
    UnoccupiedArmDesignator
from smach import StateMachine, State

STARTING_POINT = "initial_pose"

object_type = 'cup'
source_entity = 'dining_table'
dishwasher_id = 'dishwasher'
dishwasher_navigate_area = 'in_front_of'

EXIT_1 = "exit_1_rips"
EXIT_2 = "exit_2_rips"
EXIT_3 = "exit_3_rips"


class FindObject(StateMachine):
    def __init__(self, robot, item):
        StateMachine.__init__(self, outcomes=['found', 'not_found'])

        source_entity_designator = EdEntityDesignator(robot, id=source_entity)
        description_designator = VariableDesignator({
            'type': 'cup'
        })
        area_name_designator = VariableDesignator('on_top_of')
        navigation_area_designator = VariableDesignator('in_front_of')

        with self:
            StateMachine.add('SAY_LOOKING', Say(robot, ["I'm going to look for the cup"], block=False),
                             transitions={'spoken': 'FIND'})

            StateMachine.add('FIND',
                             Find(robot, source_entity_designator, description_designator, area_name_designator,
                                  navigation_area_designator, item),
                             transitions={'succeeded': 'found',
                                          'inspect_failed': 'not_found',
                                          'not_found': 'not_found'})


class CustomPlace(State):
    def __init__(self, robot, arm):
        State.__init__(self, outcomes=['placed'])
        self.robot = robot
        self.arm = arm

    def execute(self, ud):
        return 'placed'


def setup_statemachine(robot):
    item = VariableDesignator(resolve_type=Entity)
    dishwasher = EdEntityDesignator(robot=robot, id=dishwasher_id)
    arm = UnoccupiedArmDesignator([robot.leftArm], None).lockable()
    arm.lock()

    sm = StateMachine(outcomes=['done'])

    with sm:
        # Start challenge via StartChallengeRobust
        StateMachine.add('START_CHALLENGE_ROBUST',
                         StartChallengeRobust(robot, STARTING_POINT, use_entry_points=True),
                         transitions={'Done': 'NAVIGATE_TO_DISHWASHER',
                                      'Aborted': 'done',
                                      'Failed': 'NAVIGATE_TO_DISHWASHER'})

        StateMachine.add("NAVIGATE_TO_DISHWASHER",
                         NavigateToSymbolic(robot, {dishwasher: dishwasher_navigate_area}, dishwasher),
                         transitions={'arrived': 'OPEN_DISHWASHER',
                                      'unreachable': 'FIND_OBJECT',
                                      'goal_not_defined': 'FIND_OBJECT'})

        StateMachine.add("OPEN_DISHWASHER",
                         OpenDishwasher(robot, dishwasher_id),
                         transitions={'succeeded': 'FIND_OBJECT',
                                      'failed': 'FIND_OBJECT'})

        StateMachine.add('FIND_OBJECT', FindObject(robot, item),
                         transitions={'found': 'GRAB',
                                      'not_found': 'SAY_EXIT'})

        StateMachine.add('GRAB', Grab(robot, item, arm),
                         transitions={'done': 'NAVIGATE_BACK_TO_DISHWASHER',
                                      'failed': 'SAY_EXIT'})

        StateMachine.add("NAVIGATE_BACK_TO_DISHWASHER",
                         NavigateToSymbolic(robot, {dishwasher: dishwasher_navigate_area}, dishwasher),
                         transitions={'arrived': 'ASK_CONTINUE',
                                      'unreachable': 'SAY_EXIT',
                                      'goal_not_defined': 'SAY_EXIT'})

        StateMachine.add('ASK_CONTINUE', Say(robot, ["Could you please open the rack, and say continue"]),
                         transitions={'spoken': 'HEAR_CONTINUE'})

        StateMachine.add('HEAR_CONTINUE',
                         HearOptions(robot, ['continue'], rospy.Duration(10)),
                         transitions={'continue': 'CUSTOM_PLACE',
                                      'no_result': 'ASK_CONTINUE'})

        StateMachine.add('CUSTOM_PLACE', CustomPlace(robot, arm),
                         transitions={'placed': 'SAY_EXIT'})

        StateMachine.add('SAY_EXIT', Say(robot, ["I will move to the exit now. See you guys later!"], block=False),
                         transitions={'spoken': 'GO_TO_EXIT'})

        StateMachine.add('GO_TO_EXIT',
                         NavigateToWaypoint(robot, EntityByIdDesignator(robot, id=EXIT_1), radius=0.7),
                         transitions={'arrived': 'done',
                                      'unreachable': 'GO_TO_EXIT_2',
                                      'goal_not_defined': 'GO_TO_EXIT_2'})

        StateMachine.add('GO_TO_EXIT_2',
                         NavigateToWaypoint(robot, EntityByIdDesignator(robot, id=EXIT_2), radius=0.5),
                         transitions={'arrived': 'done',
                                      'unreachable': 'GO_TO_EXIT_3',
                                      'goal_not_defined': 'GO_TO_EXIT_3'})

        StateMachine.add('GO_TO_EXIT_3',
                         NavigateToWaypoint(robot, EntityByIdDesignator(robot, id=EXIT_3), radius=0.5),
                         transitions={'arrived': 'done',
                                      'unreachable': 'done',
                                      'goal_not_defined': 'done'})
    return sm


if __name__ == '__main__':
    rospy.init_node('dishwasher_exec')
    startup(setup_statemachine, challenge_name="rips")
